{% extends 'main/base.html' %}

{% block app %}
<div id="criteria-bar">
    <input type="hidden" id="criteria_url" value="{% url 'main:criteria_ajax' %}">
    <button id="dates">Dates</button>
    <button id="filters">Filters</button>
    <div id="num" style="display: inline-block; padding-left: 10px;">{{listings|length}} listing(s)</div>
</div>

<div id="dates-div-orig" style="display: none;">
    <input type="hidden" id="from_date">
    <input type="hidden" id="to_date">
    <div style="height: calc(100vh - 80px - 64px - 78px); overflow: scroll;">DATE SELECTION</div>
    <div style="height: 78px; border-top: 1px solid rgb(219, 219, 219);">CANCEL or APPLY or CLEAR</div>
</div>

<div id="filters-div" style="display: none; font-size: 19px;">
    <div style="height: calc(100vh - 80px - 64px - 78px); overflow: scroll; padding: 0 20px; font-weight: 300;">
        <div style="font-weight: 400; margin-bottom: 15px; margin-top: 20px;">Price range</div>
        <div>TODO</div>
        <div style="border-top: 1px solid rgb(219, 219, 219); font-weight: 400; margin-top: 15px; padding-top: 15px; margin-bottom: 15px;">Home type</div>
        {% for item in all_stay_types %}
            <div style="display: inline-block; width: 230px; white-space: nowrap;">
                <input class="stay_type" style="zoom: 1.5;" type="checkbox" name="{{item}}">
                {{item}}
            </div>
        {% endfor %}
        <div style="border-top: 1px solid rgb(219, 219, 219); font-weight: 400; margin-top: 15px; padding-top: 15px; margin-bottom: 15px;">Rooms and beds</div>
        <div>TODO</div>
        <div style="border-top: 1px solid rgb(219, 219, 219); font-weight: 400; margin-top: 15px; padding-top: 15px; margin-bottom: 15px;">Amenities</div>
        {% for item in all_amenities %}
            <div style="display: inline-block; width: 230px; white-space: nowrap;">
                <input class="amenities" style="zoom: 1.5;" type="checkbox" name="{{item}}">
                {{item}}
            </div>
        {% endfor %}
        <div style="border-top: 1px solid rgb(219, 219, 219); font-weight: 400; margin-top: 15px; padding-top: 15px; margin-bottom: 15px;">Facilities</div>
        {% for item in all_facilities %}
            <div style="display: inline-block; width: 230px; white-space: nowrap;">
                <input class="facilities" style="zoom: 1.5;" type="checkbox" name="{{item}}">
                {{item}}
            </div>
        {% endfor %}
        <div style="border-top: 1px solid rgb(219, 219, 219); font-weight: 400; margin-top: 15px; padding-top: 15px; margin-bottom: 15px;">Property type</div>
        {% for item in all_prop_types %}
            <div style="display: inline-block; width: 230px; white-space: nowrap;">
                <input class="prop_type" style="zoom: 1.5;" type="checkbox" name="{{item}}">
                {{item}}
            </div>
        {% endfor %}
        <div style="border-top: 1px solid rgb(219, 219, 219); font-weight: 400; margin-top: 15px; padding-top: 15px; margin-bottom: 15px;">Unique homes</div>
        {% for item in all_uniq_types %}
            <div style="display: inline-block; width: 230px; white-space: nowrap;">
                <input class="uniq_type" style="zoom: 1.5;" type="checkbox" name="{{item}}">
                {{item}}
            </div>
        {% endfor %}
        <div style="border-top: 1px solid rgb(219, 219, 219); font-weight: 400; margin-top: 15px; padding-top: 15px; margin-bottom: 15px;">House rules</div>
        <div>TODO</div>
        <div style="height: 20px;"></div>
    </div>
    <div style="height: 78px; border-top: 1px solid rgb(219, 219, 219); text-align: center; float: center;">
        <div style="display: inline-block; width: 28%; height: 50px; padding-top: 20px;"><a href="" id="reset" style="text-decoration: none; color: rgb(72, 72, 72);">Reset</a></div>
        <div style="display: inline-block; width: 28%; height: 50px; padding-top: 20px;"><a href="" id="cancel" style="text-decoration: none; color: rgb(72, 72, 72);">Cancel</a></div>
        <div style="display: inline-block; width: 28%; height: 50px; padding-top: 10px;"><button id="apply" style="outline: none; font-size: 19px; color: white; background-color: rgb(0, 132, 137); width: 100px; height: 40px; border-radius: 4px; cursor: pointer;">Apply</button></div>
    </div>
</div>

<div id="listings-div" style="height: calc(100vh - 80px - 64px); overflow: scroll; padding-right: 30px;">
    {% for listing in listings %}
    <div class="listing" id="{{listing.id}}">
        <a href="{% url 'main:listing' id=listing.id %}" target="_blank"><img src="/media/listings/{{listing.id}}/main.jpg"></a>
        <a href="{% url 'main:listing' id=listing.id %}" target="_blank">
            {% if listing.uniq_type %}
            <div style="color: rgb(165, 41, 3); font-size: 12px; font-weight: bold; padding-top: 5px;">{{listing.stay_type_str}} in {{listing.uniq_type_str}}</div>
            {% else %}
            <div style="color: rgb(165, 41, 3); font-size: 12px; font-weight: bold; padding-top: 5px;">{{listing.stay_type_str}}</div>
            {% endif %}
            <div style="color: rgb(72, 72, 72); font-size: 19px; font-weight: bold;">{{listing.name}}</div>
            <div style="color: rgb(72, 72, 72); font-size: 15px; font-weight: 300;">From {{listing.price_per_night_str}} per night</div>
        </a>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function yyyymmdd(dv) {
        let y = dv.getFullYear();
        let m = dv.getMonth() + 1;
        let d = dv.getDate();
        return "" + y + "-" + (m < 10 ? "0" : "") + m + "-" + (d < 10 ? "0" : "") + d;
    }

    function showListableIds(ids_dict_str) {
        let ids_dict = null;
        if (ids_dict_str) {
            ids_dict = JSON.parse(ids_dict_str);
        }
        let showCount = 0;
        $("#listings-div").children().each(function() {
            if (!ids_dict || !Object.keys(ids_dict).length || $(this).attr("id") in ids_dict) {
                $(this).show();
                ++showCount;
            } else {
                $(this).hide();
            }
        });
        $("#criteria-bar").find("#num").text(showCount + " listing(s)");
    }

    function getListableIds() {
        let data = {};
        let items = [ "stay_type", "amenities", "facilities", "prop_type", "uniq_type" ];

        for (let i = 0; i < items.length; ++i) {
            let selector = "." + items[i];
            let vals = [];
            $(selector).each(function() {
                if ($(this).prop("checked"))
                {
                    vals.push($(this).attr("name"));
                }
            });

            if (vals.length > 0) {
                data[items[i]] = JSON.stringify(vals);
            }
        }

        $.ajax({
            beforeSend: setCsrfToken,
            type: "POST",
            url: $("#criteria-bar").find("#criteria_url").val(),
            data: data,
            success: function(response) {
                let filtered_listing_ids_dict_str = null;
                if (response) {
                    filtered_listing_ids_dict_str = response.filtered_listing_ids_dict_str;
                }
                showListableIds(filtered_listing_ids_dict_str);
            },
            error: function(response) {
                showListableIds(null);
            }
        });
    }

    // function applyFilters() {
    //     let from_last_str = $("#criteria-vals").find("#from_last").val();
    //     let to_last_str = $("#criteria-vals").find("#to_last").val();
    //     let dict_str = $("#criteria-vals").find("#bookable_listing_ids_dict_str").val();
    //     let bookable_listing_ids_dict = null;
    //     if (dict_str) {
    //         bookable_listing_ids_dict = JSON.parse(dict_str);
    //     }

    //     if (from_last_str && to_last_str) {
    //         $("#criteria-bar").find("#dates").css("color", "white");
    //         $("#criteria-bar").find("#dates").css("background-color", "rgb(0, 132, 137)");
    //         $("#criteria-bar").find("#dates").text(from_last_str + " thru " + to_last_str);
    //     } else {
    //         $("#criteria-bar").find("#dates").css("color", "black");
    //         $("#criteria-bar").find("#dates").css("background-color", "white");
    //         $("#criteria-bar").find("#dates").text("Dates");
    //     }

    //     let amenities_last_str = $("#criteria-vals").find("#amenities_last").val();
    //     let facilities_last_str = $("#criteria-vals").find("#facilities_last").val();
    //     let rules_last_str = $("#criteria-vals").find("#rules_last").val();

    //     if (amenities_last_str || facilities_last_str || rules_last_str) {
    //         $("#filters").css("color", "white");
    //         $("#filters").css("background-color", "rgb(0, 132, 137)");
    //     } else {
    //         $("#filters").css("color", "black");
    //         $("#filters").css("background-color", "white");
    //     }

    // }

    $(document).ready(function() {
        // $("#criteria-bar").find("#dates").click(function(event) {
        //     let from_last_input = $("#criteria-vals").find("#from_last");
        //     let to_last_input = $("#criteria-vals").find("#to_last");
        //     let dict_str_input = $("#criteria-vals").find("#bookable_listing_ids_dict_str");

        //     let from_tmp_input = $("#criteria-vals").find("#from_tmp");
        //     let to_tmp_input = $("#criteria-vals").find("#to_tmp");

        //     let minDateStr = null;
        //     let cur_input = null;
        //     let title = null;

        //     if (!from_tmp_input.val()) {
        //         minDateStr = yyyymmdd(new Date());
        //         cur_input = from_tmp_input;
        //         title = "*** FROM DATE ***"
        //     } else {
        //         minDateStr = from_tmp_input.val();
        //         cur_input = to_tmp_input;
        //         title = "*** TO DATE ***"
        //     }

        //     $("#dlg-cal").dialog({
        //         autoOpen: false,
        //         height: 300,
        //         modal: true,
        //         resizable: false,
        //         title: title,
        //         width: 275,
        //         open: function() {
        //             let overlay = $(".ui-widget-overlay");
        //             overlay.css({ "opacity": "0.7", "background-color": "white" });
        //             overlay.click(function(event) {
        //                 $("#dlg-cal").dialog("close");
        //             });
        //         },
        //         close: function() {
        //             $("#dlg-cal").find("#dpDlg").datepicker("destroy");

        //             if (!cur_input.val()) {
        //                 from_tmp_input.val(null);
        //                 to_tmp_input.val(null);
        //                 return;
        //             }

        //             if (from_tmp_input.val() && !to_tmp_input.val())
        //             {
        //                 setTimeout(function() { $("#criteria-bar").find("#dates").trigger("click"); }, 100);
        //                 return;
        //             }

        //             from_last_input.val(from_tmp_input.val());
        //             to_last_input.val(to_tmp_input.val());

        //             from_tmp_input.val(null);
        //             to_tmp_input.val(null);

        //             if (from_last_input.val() && to_last_input.val()) {
        //                 $.ajax({
        //                     beforeSend: setCsrfToken,
        //                     type: "POST",
        //                     url: $("#criteria-vals").find("#criteria_url").val(),
        //                     data: {
        //                         from_date: from_last_input.val(),
        //                         to_date: to_last_input.val(),
        //                     },
        //                     success: function(response) {
        //                         let dict_str = null;
        //                         if (response) {
        //                             dict_str = response.bookable_listing_ids_dict_str;
        //                         }
        //                         dict_str_input.val(dict_str);
        //                         applyFilters();
        //                     },
        //                 });
        //             } else {
        //                 dict_str_input.val(null);
        //                 setTimeout(function() { applyFilters(); }, 100);
        //             }
        //         },
        //         buttons: {
        //             "Clear Dates": function() {
        //                 from_tmp_input.val(null);
        //                 to_tmp_input.val(null);
        //                 from_last_input.val(null);
        //                 to_last_input.val(null);
        //                 dict_str_input.val(null);
        //                 $("#dlg-cal").dialog("close");
        //                 setTimeout(function() { applyFilters(); }, 100);
        //             },
        //         },
        //     });

        //     $("#dlg-cal").find("#dpDlg").datepicker({
        //         dateFormat: "yy-mm-dd",
        //         minDate: minDateStr,
        //         onSelect: function() {
        //             let dv = $("#dlg-cal").find("#dpDlg").datepicker("getDate");
        //             cur_input.val(yyyymmdd(dv));
        //             $("#dlg-cal").dialog("close");
        //         }
        //     });

        //     $("#dlg-cal").dialog("open");
        // });
        $("#criteria-bar").find("#dates").click(function(event) {
            if ($("#dates-div-clone").length || $("#filters-div-clone").length) {
                return;
            }
        });

        $("#criteria-bar").find("#filters").click(function(event) {
            if ($("#dates-div-clone").length || $("#filters-div-clone").length) {
                return;
            }

            let orig = $("#filters-div");
            let clone = orig.clone().attr("id", "filters-div-clone");
            clone.insertAfter(orig);

            clone.find("#cancel").click(function(event) {
                event.preventDefault();
                clone.remove();
                $("#listings-div").show();
            });

            clone.find("#reset").click(function(event) {
                event.preventDefault();
                clone.remove();
                orig.find(":checkbox").prop("checked", false);
                $("#listings-div").show();
                setTimeout(function() { getListableIds(); }, 100);
            });

            clone.find("#apply").click(function(event) {
                event.preventDefault();
                orig.remove();
                clone.attr("id", "filters-div");
                clone.hide();
                $("#listings-div").show();
                setTimeout(function() { getListableIds(); }, 100);
            });

            $("#listings-div").hide();
            clone.show();
        });

        // $("#filters").click(function() {
        //     let amenities_last_input = $("#criteria-vals").find("#amenities_last");
        //     let facilities_last_input = $("#criteria-vals").find("#facilities_last");
        //     let rules_last_input = $("#criteria-vals").find("#rules_last");

        //     let amenities_tmp_input = $("#criteria-vals").find("#amenities_tmp");
        //     let facilities_tmp_input = $("#criteria-vals").find("#facilities_tmp");
        //     let rules_tmp_input = $("#criteria-vals").find("#rules_tmp");

        //     let height = 500;
        //     let width = 500;

        //     $("#dlg-filters").dialog({
        //         autoOpen: false,
        //         dialogClass: "no-close no-title",
        //         height: height,
        //         modal: true,
        //         resizable: false,
        //         width: width,
        //         // open: function() {
        //         //     let overlay = $(".ui-widget-overlay");
        //         //     overlay.css({ "opacity": "0.7", "background-color": "white" });
        //         //     overlay.click(function(event) {
        //         //         $("#dlg-filters").dialog("close");
        //         //     });
        //         // },
        //         close: function() {
        //             amenities_last_input.val(amenities_tmp_input.val());
        //             facilities_last_input.val(facilities_tmp_input.val());
        //             rules_last_input.val(rules_tmp_input.val());

        //             amenities_tmp_input.val(null);
        //             facilities_tmp_input.val(null);
        //             rules_tmp_input.val(null);

        //             if (amenities_last_input.val() || facilities_last_input.val() || rules_last_input.val()) {
        //                 $.ajax({
        //                     beforeSend: setCsrfToken,
        //                     type: "POST",
        //                     url: $("#criteria-vals").find("#criteria_url").val(),
        //                     data: {
        //                         amenities: amenities_last_input.val(),
        //                         facilities: facilities_last_input.val(),
        //                         rules: rules_last_input.val(),
        //                     },
        //                     success: function(response) {
        //                         if (response) {
        //                             // $("#criteria-vals").find("#x").val(response.x);
        //                         }
        //                         applyFilters();
        //                     },
        //                 });
        //             } else {
        //                 setTimeout(function() { applyFilters(); }, 100);
        //             }
        //         },
        //     });

        //     $("#dlg-filters").dialog("open");
        // });
    });
</script>
{% endblock %}

