{% extends 'main/base.html' %}

{% block app %}
<div id="dlg-cal"><div id="dpDlg"></div></div>

<div id="filter-vals" style="display: none;">
    <input type="hidden" id="from">
    <input type="hidden" id="to">
    <input type="hidden" id="filter_url" value="{% url 'main:filter_ajax' %}">
</div>

<div class="filter-bar">
    <button id="dates">Dates</button>
    <button id="filters">Filters</button>
</div>

<div style="height: calc(100vh - 80px - 64px); overflow: scroll; padding-right: 30px;">
    {% for listing in listings %}
    <div class="listing">
        <a href="{% url 'main:listing' id=listing.id %}" target="_blank"><img src="/media/listings/{{listing.id}}/main.jpg"></a>
        <a href="{% url 'main:listing' id=listing.id %}" target="_blank">
            {% if listing.uniq_type %}
            <div style="color: rgb(165, 41, 3); font-size: 12px; font-weight: bold; padding-top: 5px;">{{listing.stay_type_str}} in {{listing.uniq_type_str}}</div>
            {% else %}
            <div style="color: rgb(165, 41, 3); font-size: 12px; font-weight: bold; padding-top: 5px;">{{listing.stay_type_str}}</div>
            {% endif %}
            <div style="color: rgb(72, 72, 72); font-size: 19px; font-weight: bold;">{{listing.name}}</div>
            <div style="color: rgb(72, 72, 72); font-size: 15px; font-weight: 300;">From {{listing.price_per_night_str}} per night</div>
        </a>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function yyyymmdd(dv) {
        var y = dv.getFullYear();
        var m = dv.getMonth() + 1;
        var d = dv.getDate();
        return "" + y + "-" + (m < 10 ? "0" : "") + m + "-" + (d < 10 ? "0" : "") + d;
    }

    function applyDateFilter() {
        $.ajax({
            beforeSend: setCsrfToken,
            type: "POST",
            url: $("#filter-vals").find("#filter_url").val(),
            data: {
                fromDate: $("#filter-vals").find("#from").val(),
                toDate: $("#filter-vals").find("#to").val(),
            },
            success: function(response) {
                console.log(response);
            },
        });
    }

    $(document).ready(function() {
        $("#dates").click(function() {
            let from = $("#filter-vals").find("#from");
            let to = $("#filter-vals").find("#to");

            if (from.val() && to.val()) {
                from.val(null);
                to.val(null);
                $("#dates").css("background-color", "white");
                $("#dates").css("color", "black");
                $("#dates").text("Dates");
            }

            let minDateStr = null;
            let storage = null;
            let title = null;

            if (!from.val()) {
                minDateStr = yyyymmdd(new Date());
                storage = from;
                title = "FROM Date:"
            } else {
                minDateStr = from.val();
                storage = to;
                title = "TO Date:"
            }

            $("#dlg-cal").dialog({
                autoOpen: false,
                height: 300,
                modal: true,
                resizable: false,
                title: title,
                width: 275,
                open: function() {
                    let overlay = $(".ui-widget-overlay");
                    overlay.css({ "opacity": "0.7", "background-color": "black" });
                    overlay.click(function(event) {
                        $("#dlg-cal").find("#dpDlg").datepicker("destroy");
                        $("#dlg-cal").dialog("close");
                    });
                },
                buttons: {
                    Clear: function() {
                        from.val(null);
                        to.val(null);
                        $("#dates").css("background-color", "white");
                        $("#dates").css("color", "black");
                        $("#dates").text("Dates");
                        $("#dlg-cal").find("#dpDlg").datepicker("destroy");
                        $("#dlg-cal").dialog("close");
                    },
                },
            });
            $("#dlg-cal").find("#dpDlg").datepicker({
                dateFormat: "yy-mm-dd",
                minDate: minDateStr,
                onSelect: function() {
                    let dv = $("#dlg-cal").find("#dpDlg").datepicker("getDate");
                    storage.val(yyyymmdd(dv));
                    if (storage == from) {
                        setTimeout(function() { $("#dates").trigger("click"); }, 100);
                    } else {
                        $("#dates").css("background-color", "rgb(0, 132, 137)");
                        $("#dates").css("color", "white");
                        $("#dates").text(from.val() + " thru " + to.val());
                        setTimeout(function() { applyDateFilter(); }, 100);
                    }
                    $("#dlg-cal").find("#dpDlg").datepicker("destroy");
                    $("#dlg-cal").dialog("close");
                }
            });
            $("#dlg-cal").dialog("open");
        });
    });
</script>
{% endblock %}

